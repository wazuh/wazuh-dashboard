name: Build final packages

on:
  workflow_dispatch:
    inputs:
      system:
        type: choice
        description: 'Package OS'
        required: true
        options:
          - deb
          - rpm
        default: 'deb'
      architecture:
        type: choice
        description: 'Package architecture'
        required: true
        options:
          - amd64
          - x86_64
        default: amd64
      revision:
        type: string
        description: 'Package revision'
        required: true
        default: '0'
      reference_security_plugins:
        type: string
        description: 'Branch/tag/commit of the wazuh-security-dashboards-plugin repository to build the security plugin'
        required: true
        default: 'master'
      reference_wazuh_plugins:
        type: string
        description: 'Branch/tag/commit of the wazuh-dashboard-plugins repository to build the main plugins'
        required: true
        default: 'master'
      is_stage:
        type: boolean
        description: 'Set production nomenclature'
        required: true
        default: false
      checksum:
        type: boolean
        description: 'Generate package checksum'
        required: true
        default: false


jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    name: Validate inputs
    steps:
      - name: Validate inputs
        run: |
          if [ "${{ inputs.architecture }}" = "amd64" ] && [ "${{ inputs.system }}" = "rpm" ]; then
            echo "Invalid combination of architecture and system"
            exit 1
          fi
          if [ "${{ inputs.architecture }}" = "x86_64" ] && [ "${{ inputs.system }}" = "deb" ]; then
            echo "Invalid combination of architecture and system"
            exit 1
          fi

  build-dashboard:
    needs: [validate-inputs]
    name: Build dashboard
    uses: wazuh/wazuh-dashboard/.github/workflows/build.yml@modify-package-generation-actions
    with:
      CHECKOUT_TO: ${{ github.head_ref || github.ref_name }}
      CACHE: true

  build-plugins:
    needs: [validate-inputs]
    name: Build plugins
    uses: wazuh/wazuh-dashboard/.github/workflows/build_and_cache_plugins.yml@modify-package-generation-actions
    with:
      reference_wazuh_plugins: ${{ inputs.reference_wazuh_plugins }}
      reference_security_plugins: ${{ inputs.reference_security_plugins }}

