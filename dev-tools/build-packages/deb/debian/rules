#!/usr/bin/make -f

# ðŸ‘‰ If you donâ€™t set `.ONESHELL:`, each line of the recipe runs in a separate
# shell (which is the default in Makefiles). With `.ONESHELL:`, all lines of the
# same target run in a single shell, so local shell variables are preserved.
.ONESHELL:
SHELL := /bin/bash

# -*- makefile -*-
# Sample debian/rules that uses debhelper.
#
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets by Bill Allombert 2001
#
# Modified by Wazuh
# Copyright (C) 2021, Wazuh Inc.
#
# This program is a free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation.

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

export TARGET_DIR=${CURDIR}/debian/wazuh-dashboard
export NAME=wazuh-dashboard
export CONFIG_DIR=/etc/$(NAME)
export INSTALLATION_DIR=$(INSTALLATION_DIR)
export USER=$(NAME)
export GROUP=$(NAME)
export DASHBOARD_FILE=wazuh-dashboard.tar.gz
export PLUGINS_DIR=$(INSTALLATION_DIR)/plugins

# -----------------------------------------------------------------------------

%:
	dh $@

# -----------------------------------------------------------------------------

override_dh_shlibdeps:

# -----------------------------------------------------------------------------

override_dh_auto_configure:

# -----------------------------------------------------------------------------

override_dh_auto_install:

# -----------------------------------------------------------------------------

override_dh_install:
	cp /tmp/$(DASHBOARD_FILE) ./

	groupadd $(GROUP)
	useradd -g $(GROUP) $(USER)

	tar -xf $(DASHBOARD_FILE)
	sed -i 's/OSD_NODE_OPTS_PREFIX/OSD_PATH_CONF="\/etc\/wazuh-dashboard" OSD_NODE_OPTS_PREFIX/g' "wazuh-dashboard-base/bin/opensearch-dashboards"
	sed -i 's/OSD_USE_NODE_JS_FILE_PATH/OSD_PATH_CONF="\/etc\/wazuh-dashboard" OSD_USE_NODE_JS_FILE_PATH/g' "wazuh-dashboard-base/bin/opensearch-dashboards-keystore"


	mkdir -p $(TARGET_DIR)$(CONFIG_DIR)
	mkdir -p $(TARGET_DIR)$(INSTALLATION_DIR)
	mkdir -p $(TARGET_DIR)/etc/systemd/system
	mkdir -p $(TARGET_DIR)/etc/default

	mv wazuh-dashboard-base/config/node.options $(TARGET_DIR)$(CONFIG_DIR)
	mv wazuh-dashboard-base/config/opensearch_dashboards.yml $(TARGET_DIR)$(CONFIG_DIR)
	mv wazuh-dashboard-base/* $(TARGET_DIR)$(INSTALLATION_DIR)

	mkdir -p $(TARGET_DIR)$(INSTALLATION_DIR)/config

	cp $(TARGET_DIR)$(INSTALLATION_DIR)/wazuh-dashboard.service $(TARGET_DIR)/etc/systemd/system/wazuh-dashboard.service
	cp $(TARGET_DIR)$(INSTALLATION_DIR)/wazuh-dashboard $(TARGET_DIR)/etc/systemd/system/$(NAME)
	cp $(TARGET_DIR)$(INSTALLATION_DIR)/default $(TARGET_DIR)/etc/default/$(NAME)

	rm -rf $(TARGET_DIR)$(INSTALLATION_DIR)/etc

	chown -R $(USER):$(GROUP) $(TARGET_DIR)$(INSTALLATION_DIR)
	chown -R $(USER):$(GROUP) $(TARGET_DIR)$(CONFIG_DIR)

	find $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/wazuh/ -exec chown $(USER):$(GROUP) {} \;

# -----------------------------------------------------------------------------

override_dh_fixperms:
	chmod 750 $(TARGET_DIR)$(CONFIG_DIR)
	chown -R $(USER):$(GROUP) $(TARGET_DIR)$(CONFIG_DIR)
	chmod 750 $(TARGET_DIR)$(INSTALLATION_DIR)
	chown -R $(USER):$(GROUP) $(TARGET_DIR)$(INSTALLATION_DIR)
	chown root:root $(TARGET_DIR)/etc/systemd/system/wazuh-dashboard.service
	chown root:root $(TARGET_DIR)/etc/systemd/system/"$(NAME)"
	chown $(USER):$(GROUP) $(TARGET_DIR)/etc/default/"$(NAME)"
	chown $(USER):$(GROUP) $(TARGET_DIR)$(INSTALLATION_DIR)/VERSION.json
	chmod 440 $(TARGET_DIR)$(INSTALLATION_DIR)/VERSION.json
	chmod 750 $(TARGET_DIR)/etc/systemd/system/wazuh-dashboard
	chmod 750 $(TARGET_DIR)/etc/default/wazuh-dashboard
	chmod 640 "$(TARGET_DIR)$(CONFIG_DIR)"/opensearch_dashboards.yml
	chmod 640 "$(TARGET_DIR)$(CONFIG_DIR)"/node.options
	chmod 644 $(TARGET_DIR)/etc/systemd/system/wazuh-dashboard.service
	find "$(TARGET_DIR)$(INSTALLATION_DIR)" -type d -exec chmod 750 {} \;
	find "$(TARGET_DIR)$(INSTALLATION_DIR)" -type f -perm 644 -exec chmod 640 {} \;
	find "$(TARGET_DIR)$(INSTALLATION_DIR)" -type f -perm 755 -exec chmod 750 {} \;
	find "$(TARGET_DIR)$(INSTALLATION_DIR)" -type f -perm 744 -exec chmod 740 {} \;

# -----------------------------------------------------------------------------

override_dh_strip:
	dh_strip --no-automatic-dbgsym -XlibGLESv2.so -XlibEGL.so

# -----------------------------------------------------------------------------

assistant_dashboard_whitelabeling:
	ASSISTANT_DASHBOARD_PLUGIN_DIR="$(PLUGINS_DIR)/assistantDashboards"
	TARGET_PUBLIC_DIR="$$ASSISTANT_DASHBOARD_PLUGIN_DIR/target/public"
	CHUNK_FILE="$$TARGET_PUBLIC_DIR/assistantDashboards.chunk.10.js"
	PLUGIN_FILE="$$TARGET_PUBLIC_DIR/assistantDashboards.plugin.js"

	OLD_IMAGE="base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMzAuODMzMyAzOS44NTlDMzEuODk2MiAzOS40Mzk4IDMxLjg2OCAzOC4xMTU5IDMxLjg2OCAzNy4wMjk0VjMyLjY2NjZIMzQuMjg1N0MzNy40NDE3IDMyLjY2NjYgNDAgMzAuMjUzOSA0MCAyNy4yNzc1VjcuMzg5MTRDND.*InVzZXJTcGFjZU9uVXNlIj4KICAgIDxzdG9wIHN0b3AtY29sb3I9IiMwMEEzRTAiLz4KICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzAwQTNFMCIgc3RvcC1vcGFjaXR5PSIwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPC9kZWZzPgo8L3N2Zz4="

	NEW_IMAGE="base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNTEyIDUxMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8Zz4KCTxwYXRoIGZpbGw9IiMwMDZCQjQiIGQ9Ik00MDQuNSwyMS4yVjBoLTI5N0M0OC45LDAsMS40LDQ3LjUsMS40LDEwNi4xdjE2OS43YzAsNTguNiw0Ny41LDEwNi4xLDEwNi4xLDEwNi4xaDI0Ni45TDUxMC42LDUxMlYxMDYuMQoJCUM1MTAuNiw0Ny41LDQ2My4xLDAsNDA0LjUsMFYyMS4ydjIxLjJjMzUuMSwwLjEsNjMuNiwyOC41LDYzLjYsNjMuNnYzMTUuM2wtOTguNC04MkgxMDcuNWMtMzUuMS0wLjEtNjMuNi0yOC41LTYzLjYtNjMuNmwwLTE2OS43CgkJYzAuMS0zNS4xLDI4LjUtNjMuNiw2My42LTYzLjZoMjk3VjIxLjJ6IE00MDQuNSwxMjcuM0gxMjguN3Y0Mi40aDI3NS44VjEyNy4zeiBNNDA0LjUsMjEyLjFIMjEzLjZ2NDIuNGgxOTAuOVYyMTIuMXoiLz4KPC9nPgo8L3N2Zz4K"

	cp $$CHUNK_FILE{,.bak}
	cp $$PLUGIN_FILE{,.bak}

	mv $$CHUNK_FILE.br{,.bak}
	mv $$CHUNK_FILE.gz{,.bak}
	mv $$PLUGIN_FILE.br{,.bak}
	mv $$PLUGIN_FILE.gz{,.bak}

	sed -i -e "s|OpenSearch Assistant|Dashboard assistant|g" $$CHUNK_FILE
	sed -i -e "s|OpenSearch Assistant|Dashboard assistant|g" $$PLUGIN_FILE
	sed -i -e "s|he Dashboard assistant|he dashboard assistant|g" $$PLUGIN_FILE

	sed -i -e "s|$$OLD_IMAGE|$$NEW_IMAGE|" $$PLUGIN_FILE

	gzip -c -9 "$$PLUGIN_FILE" > "$$PLUGIN_FILE.gz"
	gzip -c -9 "$$CHUNK_FILE" > "$$CHUNK_FILE.gz"

	brotli -q 11 -f "$$PLUGIN_FILE" -o "$$PLUGIN_FILE.br"
	brotli -q 11 -f "$$CHUNK_FILE" -o "$$CHUNK_FILE.br"

# -----------------------------------------------------------------------------

.PHONY: override_dh_strip override_dh_auto_clean override_dh_auto_build override_dh_auto_configure assistant_dashboard_whitelabeling
